---
title: "系统设计面试 101"
date: 2019-07-21T00:10:14+08:00
weight: 5
---

求职系列文章：

- [如何准备技术面试](../面试准备/)
- [如何写一份更好的简历](../如何写一份更好的简历/)
- [程序员国外求职指南](../程序员国外求职指南/)


在初接触系统设计的面试的时候，我猜想系统设计需要对目标项目所涉及的架构与解决方案有详尽的了解。例如当谈到需要用 Nginx 做负载均衡时，需要阐述 Nginx 处理请求的流程，基础模型，什么情况下会失效，失效如何复位。但是经过几次面试，反馈，以及大量的阅读之后。我发现对于有一定项目经验的人来说，**系统设计的流程往往比细节更重要，只要把主要功能点与基本框架描述清楚，再就自己熟悉的方向深入作答，就能得到不错的评价。**这篇文章的母的并不是教你如何设计一套高可用的系统（在文末我会提供一些学习资料）。而是让你在阅读完这些资料的时候，发挥出真实的架构能力。

#### 资源推荐
就像算法题中，了解基础的数据结构能够帮助我们解决问题，系统设计也需要我们了解一些常用的软件架构以及使用场景，这里我列出了一些常用软件的基础教程，如果你不知道这个应用的使用场景，应该花 10分钟 左右了解以下。

[Inside NGINX: How We Designed for Performance & Scale](https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/)
[Introduction to Redis](https://redis.io/topics/introduction)
[How does Hadoop work and how to use it?](https://www.dezyre.com/article/hadoop-explained-how-does-hadoop-work-and-how-to-use-it-/237)
[Kafka](https://www.cloudkarafka.com/blog/2016-11-30-part1-kafka-for-beginners-what-is-apache-kafka.html)
[Highscalability all time favorites](http://highscalability.com/all-time-favorites/) 里面包含了非常多现实项目的设计以及优化方式，阅读之后能有非常大的帮助。
[System design primer](https://github.com/donnemartin/system-design-primer) 是 Github 上的系统设计集合的项目，新手刚开始看会觉得太多内容，所以我建议按需阅读。

#### 面试流程
系统设计总体可以分成 5个 部分：

1. 确定范围（5分钟）
2. 粗略计算（5分钟）
3. 系统架构（20分钟）
4. 分析瓶颈（10分钟）
5. 架构优化（10分钟）

#### 确定范围
面试开始，面试官可能只提出一个要求：

> “如何设计像一个 Uber 这样的应用？”

> “如何设计像一个 Whatsapp 这样的应用？”

> “如何设计一个分布式日志系统？”

别紧张，这个问题一开始看起来很难，但是，面试官并不期待你可以在一小时内把 Uber 或者 Whatsapp 的全部功能设计出来，也不现实。此时考核的是求职者在遇到一个一个笼统抽象的问题时，如何通过分析以及推理把它转变成实际工程中解决的小问题。**求职者能否提出好的问题以及注意设计中潜在的瓶颈这两点非常重要。**简单来说，第一步需要通过提问来确定问题的范围。以设计 Uber 为例：

> “Uber 包括很多功能，例如车辆预订，系统派单，司机路径显示，费用支付，评价，日志分析等等。”

把你想到的主要功能点都列出来，写在白板上，然后选出一到两项主要功能以及一项自己比较熟悉的附加功能？在 Uber 应用中，车辆预订，系统派单这两个功能是最重要的，剩下的，司机路径显示，费用支付，评价，日志分析中，如果你之前对其中某个功能有了解过，可以在主功能的基础上加上它，这里我假设你对费用支付比较了解。确定好之后询问面试官：

![system_board]()

> “我从这几个功能开始进行设计可以吗？”

如果面试官关注其他功能的话，可能还需要修改，不过大概率是没有问题的，因为设计涵盖了主要功能。接下来的问题，我们需要确定功能点中，关键模块的每秒请求量，数据存储量，两者增长速度以及其他限制。这里车辆预订很可能是最多请求量的，所以我们从此功能开始设计以及询问：

> “车辆预订模块每秒的请求量是多少？有多少数据需要存储？用户的增长量是多少？对响应时间以及服务器数量有没有要求？”

运气好的话面试官会直接回答你“车辆预订模块每秒有 1000次 请求，每天有 100G 数据需要存储，用户每月增长 10%，服务器不能超过 20台。”这些都需要在白板上记录下来，当然，面试官也可能不直接回答你的问题，而回答“每天有 100万 人次使用车辆预订，需要存储每次预订的所有信息，包括订单号，起点，终点，路径经纬度等。其他没有限制。”，这时候你就需要进入**粗略估算**环节：

#### 粗略估算
粗略故事是每名工程师都需要学习的技巧，把现有的数据转换成我们需要的数据。首先我们需要了解一些基础数字：

一小时有 3600秒
一天有 86400秒
80% 的请求出现在 20% 的时间


在例子中，每天有 100万人次车辆预订，我们可以假定每次预订发送两个请求，也就是说20% 的时间，5小时 18000秒 内需要处理包含了 160万个 请求，平均 88res/s。我们假设上下班峰值为 300% 即车辆预订模块需要达到 300res/s。那么 300res/s 是什么水平呢？这个根据业务的复杂度不同有很大区别，不过为了给各位一个量化的标准，我引用了《构建高可用web站点》里的数据，注意，这里处理的是web请求，通常来说比较简单，所以吞吐量也会较高。此时白板是

![system_board]()


我保守猜测服务器能够处理 50res/s，在这个例子中，我们需要6台后端服务器来处理车辆预订请求。

#### 系统架构
终于来到系统架构环节，我想大多数求职者都没有设计过 Uber，也没写过车辆预订的相应业务代码，没有关系，**跳脱于应用本身，而从功能点出发设计才是关键**，我们看看车辆预订功能到底做了什么。


1. 用户选择起点以及终点 -> 服务器返回大概价格以及计划路线。
2. 当用户点击车辆预订 -> 服务器开始派单并显示该司机有关信息。

定价背后的逻辑当然非常复杂，涉及到叫车人数与周围司机数量的比值，我们称为需求量，需求越高，价格越贵，叫车时间，以及距离几个因素。我不清楚uber实际的实现逻辑（当然这也是商业秘密），不过我猜测会有这样的关系式：

    距离 > 需求量 > 叫车时间 

重复一次，这并不是真实的情况，只是我猜测的关系式，而uber在开发的过程中，必定会对这个关系式做调整来达到利益最大化，一开始是试验的阶段，所以其实可以随便写。我们可以假定里面的系数，其中距离的变动最多，我们有类似的一个表格

| 范围        | 距离  |
| ----------- | ------|
| 1公里以内   | 8 元  |
| 1到2公里    | 9 元  |

| 范围        | 需求量  |
| ----------- | --------|
| 1-2         | 1.2 倍  |
| 2-4         | 1.4 倍  |

其中公式中每个系数都可以有对应的一个表格，每一次用户点击叫车的时候，系统会计算相应的价格。好吧，那么这里的数据怎么存储呢？服务器内存还是文件形式还是数据库，如果是数据库的话是 SQL 还是 NoSQL。这里的基本原则是，如果我们暂时不知道瓶颈在哪里的时候，但是数据又需要持久化存储，我们优先使用 SQL 数据库。我们现在可以将定价理解成一个 API 接口，手机应用发送出发点与终点的距离，当前的经纬度（用于给服务器计算需求量）以及当前时间给服务器，然后服务器就会返回价格。现阶段的架构如下

![架构]()

这时候，我们有一个简单的架构了，当然我们这里没有使用负载均衡或者应用层的缓存，如果你有架构经验的话，可以看到在应用服务器群前可以加一个负载均衡，让请求分发到不同的 API 服务器。不过这点在之后的分析瓶颈我们再加上就好。另外一个问题是，怎么计算需求量呢？更详细的是，如何找到在经纬度3公里范围内所有在线并且空闲的司机呢？分析一下，这里有三个要点“三公里内”，“在线”，“空闲”，第一个和第三个毕竟容易，我们只需要在查询数据的时候附带筛选条件即可，我们可以猜测我们在某个地方存储了所有司机的信息。里面包含了司机当前的经纬度，最后一次在线时间以及是否空闲。我们只需要在某个地方进行查询即可。空闲则查询用户是否在线，这点比较关键，而且在多个系统设计都可能应用到，例如whatsapp需要检测用户是否在线，一在线就需要发送之前服务器存储的消息给他。其实这个有两种方式来实现，这点比较重要，所以我想着重分析下。最简单而且一开始使用的方法，可以使用 SQL 表来判断，每当用户有操作的时候（无论是请求哪一个api，或者与服务器使用websocket连接）我们都有它请求时的token（或者cookies），我们通过这个token 查找到对应的用户并且更新 last_online_time，那么我们查询在线用户只需要从此表中找到，1分钟内在线的用户即可。这个方法非常适合用户量不多的情况，不过缺点也很明显，第一是不及时，加入用户下线了30秒的话，我们的系统察觉不了，第二是每次都需要更新，速度可能比较慢，当然在这里我们可以使用 NoSQL来代替。第二种方法是使用双向连接，例如websocket，系统可能用到也可能没用到。简单介绍websocket，就是服务器可以直接给客户端推送消息，同时服务端也能查询到客户端连接是否被关闭，即在线情况。这样就简单得多，每次用户使用websocket连接了服务端，服务端记录客户端状态为在线，一旦连接断了，记录不在线。然后存储在NoSQL中，查询即可。

找到司机之后，派单，那么派给谁呢？这里涉及的业务部分比较多，评价高的，距离最近的，每个司机最终会加权得到一个值，然后取最小值的即可。

司机接单后就可以进行路径渲染了，这部分细节的难点非常多，例如滴滴使用的是FLP融合定位，在GPS有问题的时候，使用wifi，道路匹配，车辆航位推算因为要把车实时显示在正确的道路上，其中影响的因素有，这是道路吗？汽车的方向。简单来说是把司机的经纬度传到手机app端，手机进行分析以及渲染。具体细节如果你了解的话可以进行阐述。期间，你需要和面试官不断沟通，看他是否认可你的方案，如果他给出提示的话，你可以根据他的提示来修改（面试官在面试前对题目的了解比我们要多，大多情况下跟着他没错）

#### 分析瓶颈
瓶颈结合我们一开始的数字，一台服务器够吗？当然不够，那么使用多少台，简单的计算。多台服务器如何分配任务？负载均衡。

#### 架构优化
现在我们得到这样的一张系统架构图，基本的设计模式如下，应用集群前加上负载均衡，关系型弱的数据使用NoSQL，计算耗时久的数据保存在NoSQL，所有工具都需要做集群（这里涉及一个问题，集群原理，集群失效如何恢复，可以参考文章最开始的链接学习，通常方法就两种，一种 failover，一种 沉鱼。关系型数据库做主从热备，然后写在主数据库，从数据库进行读。（阅读mysql 主从热备），那么最终我们可以得到这个架构图。

#### 互相沟通
和面试官交流
